#!/bin/zsh
SALT=`date +%g`
gcc -std=c99 -m32 -o protect protect.c
if [[ ARGC -gt 0 ]] then
  BINNAME=`basename $PWD`
  foreach USER ($@)
    mkdir -p obj/$USER
    AA=`echo $USER $SALT $BINNAME | sha512sum | base64 | head -1 | cut -c 1-8`
    cat program.c.template | sed s/AAAAAA/$AA/ >! program.c
    gcc -static -m32 -o obj/$USER/$BINNAME program.c
    cat program.c.template >! program.c
    gcc -static -m32 -o obj/$USER/${BINNAME}.orig program.c
    upx -qqq obj/$USER/$BINNAME
    ./protect obj/$USER/$BINNAME
  end
  rm program.c
else
  echo "USAGE: build.zsh <user_email(s)>"
fi
