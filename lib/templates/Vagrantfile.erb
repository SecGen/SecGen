# -*- mode: ruby -*-
# vi: set ft=ruby :

# This file was generated by SecGen
# <%= @time %>
# Based on <%= @scenario %>
<% require 'json'
   require 'base64' -%>
<% prefix = @options[:prefix] + '_' -%>
VAGRANTFILE_API_VERSION = "2"

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
<% @systems.each do |system| %>
    <%  system.module_selections.each do |selected_module|
      if selected_module.module_type == 'base'
        @cpu_word_size = selected_module.attributes['cpu_word_size'].first.downcase
        if (@options.has_key? :ovirtuser) && (@options.has_key? :ovirtpass)
          @ovirt_base_template = selected_module.attributes['ovirt_template'].first
        end
      end
    end -%>
  config.vm.define "<%= system.name %>" do |<%= system.name %>|
<% if (@options.has_key? :ovirtuser) && (@options.has_key? :ovirtpass) %>
    #oVirt provider begin
    config.vm.provider :ovirt4 do |ovirt|
    <%=
"    ovirt.username = '#{@options[:ovirtuser]}'
        ovirt.password = '#{@options[:ovirtpass]}'" %>
    <%= if @options.has_key? :ovirturl
"    ovirt.url = '#{@options[:ovirturl]}'"
        end %>
    <%= if @options.has_key? :ovirtcluster
"    ovirt.cluster = '#{@options[:ovirtcluster]}'"
        end
"    ovirt.template = '#{@ovirt_base_template}'" %>
        ovirt.insecure = true
        ovirt.debug = true
    end
    # oVirt provider end
<%
  else %>
    config.vm.provider :virtualbox do |vb|
<%  system.module_selections.each do |selected_module|
      if selected_module.module_type == 'base'
        @cpu_word_size = selected_module.attributes['cpu_word_size'].first.downcase
      end
    end -%>
<%= gui = (@options.has_key? :gui_output) ? 'true' : 'false'
      "      vb.gui = #{gui}\n" -%>
<%= no_pae = (@options.has_key? :nopae) ? 'off' : 'on'
      "      vb.customize ['modifyvm', :id, '--pae', '#{no_pae}']\n" -%>
<%= if @cpu_word_size == '32-bit'
      if @options.has_key? :hwvirtex
      "      vb.customize ['modifyvm', :id, '--hwvirtex', 'on']\n"
      else
      "      vb.customize ['modifyvm', :id, '--hwvirtex', 'off']\n"
      end
    elsif @cpu_word_size == '64-bit'
      "      vb.customize ['modifyvm', :id, '--hwvirtex', 'on']\n"
    end -%>
<%= vtxpid = (@options.has_key? :vtxvpid) ? 'on' : 'off'
      "      vb.customize ['modifyvm', :id, '--vtxvpid', '#{vtxpid}']\n"  -%>
<%= if @options.has_key? :memory_per_vm
      "      vb.memory = #{@options[:memory_per_vm]}\n"
    elsif @options.has_key? :total_memory
      "      vb.memory = #{@options[:total_memory]}/#{@systems.length}\n"
    end -%>
<%= if @options.has_key? :max_cpu_cores
      "      vb.cpus = #{@options[:max_cpu_cores]}\n"
    end -%>
<%= if @options.has_key? :max_cpu_usage
      "      vb.customize ['modifyvm', :id, '--cpuexecutioncap', '#{@options[:max_cpu_usage]}']\n"
    end -%>
    end
<% end %>
    # SecGen datastore
    # <%= JSON.generate($datastore) %>

    # SecGen modules
<% system.module_selections.each do |selected_module| -%>

<%= selected_module.to_s_comment -%>
<%   case selected_module.module_type
     when 'base' -%>
    <% if (@options.has_key? :ovirtuser) && (@options.has_key? :ovirtpass) %>   # TODO
    <%= system.name %>.vm.hostname = '<%= "#{prefix}SecGen-#{selected_module.attributes['system_name']}_#{Time.new.strftime("%Y%m%d-%H%M")}" %>'
    <%= system.name %>.vm.box = 'ovirt4' # TODO
    <%= system.name %>.vm.box_url = ''   # TODO
    <% else %>
    <%= system.name %>.vm.box = "<%= selected_module.module_path_name %>"
    <%= system.name %>.vm.box_url = "<%= selected_module.attributes['url'].first %>"
    <% end %>
    <% if selected_module.attributes['platform'].first.downcase == 'windows' %>
    <%= system.name %>.vm.communicator = 'winrm'
    <%= system.name %>.vm.guest = :windows
    <%= system.name %>.vm.network :forwarded_port, guest: 3389, host: 3389
    <%= system.name %>.vm.network :forwarded_port, guest: 5985, host: 5985, id: "winrm", auto_correct: true
    <% end %>
<%   when 'network' -%>
<%     if selected_module.attributes['range'].first.nil? || selected_module.attributes['range'].first == "dhcp" -%>
  <%       if (@options.has_key? :ovirtnetwork) && (@options.has_key? :ovirtuser) && (@options.has_key? :ovirtpass)  %>
      <%= system.name %>.vm.network :<%= selected_module.attributes['type'].first %>, :ovirt__network_name => '<%= "#{@options[:ovirtnetwork]}" %>'
  <%       else %>
      <%= system.name %>.vm.network :<%= selected_module.attributes['type'].first %>, type: "dhcp"
  <%       end %>
<%     else -%>
  <%       if (@options.has_key? :ovirtuser) && (@options.has_key? :ovirtpass) %>
      <%= system.name %>.vm.network :<%= selected_module.attributes['type'].first %>, :ovirt__ip => "<%= resolve_network(selected_module.attributes['range'].first)%>"
  <%       else %>
      <%= system.name %>.vm.network :<%= selected_module.attributes['type'].first %>, ip: "<%= resolve_network(selected_module.attributes['range'].first)%>"
  <%       end %>
<%     end -%>
<%   when 'vulnerability', 'service', 'utility', 'build' -%>
<%     module_name = selected_module.module_path_name -%>
    <%= system.name %>.vm.provision "puppet" do | <%=module_name%> |
<%     # if there are facter variables to define
      if selected_module.received_inputs != {} -%>
      <% json_inputs = JSON.generate(selected_module.received_inputs) -%>
<%=   module_name%>.facter = {
        "base64_inputs" => '<%= Base64.strict_encode64(json_inputs)%>'
      }
<%    end -%>
      <%=module_name%>.module_path = "<%="puppet/#{system.name}/modules"%>"
      <%=module_name%>.environment_path = "environments/"
      <%=module_name%>.environment = "production"
      <%=module_name%>.synced_folder_type = "rsync"
      <%=module_name%>.manifests_path = "<%="puppet/#{system.name}/modules/#{selected_module.module_path_end}"%>"
      <%=module_name%>.manifest_file = "<%="#{selected_module.module_path_end}.pp"%>"
    end
<%   end -%>
<% end -%>
  end
<% end %>
end
